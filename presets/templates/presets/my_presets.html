{% extends "base.html" %}

{% block title %}My Profile{% endblock %}

{% block content %}
    <div class="grid mb-1">
        <h1 style="margin-bottom: 0;">My Profile</h1>
        <div style="text-align: right;">
            <a href="{% url 'preset-create' %}" role="button">Create a New Preset</a>
        </div>
    </div>

    <div class="grid">
        <article>
            <h3 class="stat-header">Total Seeds Rolled</h3>
            <p class="stat-number">{{ total_rolls }}</p>
        </article>
        <article>
            <h3 class="stat-header">Favorite Preset</h3>
            <p class="stat-number">
                {% if favorite_preset != "N/A" %}
                    {{ favorite_preset.seed_type }}
                    <small>({{ favorite_preset.roll_count }} rolls)</small>
                {% else %}
                    No seeds rolled yet
                {% endif %}
            </p>
        </article>
    </div>

    <article>
        <header>
            <h2>Recently Rolled Seeds</h2>
        </header>
        {% if recent_rolls %}
            <table>
                <thead>
                    <tr>
                        <th>Preset</th>
                        <th>Time</th>
                        <th>Link</th>
                    </tr>
                </thead>
                <tbody>
                    {% for roll in recent_rolls %}
                    <tr>
                        <td>{{ roll.seed_type }}</td>
                        <td>{{ roll.timestamp }}</td>
                        <td>
                            {% if roll.share_url %}
                                {# Check the first 7 characters for '/media/' #}
                                {% if roll.share_url|slice:":7" == '/media/' %}
                                    <a href="{{ roll.share_url }}" download>Download</a>
                                {% else %}
                                    <a href="{{ roll.share_url }}" target="_blank">Link</a>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>You haven't rolled any seeds yet.</p>
        {% endif %}
    </article>

    <hr>

    <h2>My Created Presets</h2>
    <form method="get" class="filter-bar">
        <input 
            type="search" 
            id="search"
            name="q" 
            placeholder="Search my presets..." 
            value="{{ search_query }}"
        >
        <select name="sort" id="sort" onchange="this.form.submit()">
            <option value="name" {% if current_sort == "name" %}selected{% endif %}>Sort: Alphabetical</option>
            <option value="-count" {% if current_sort == "-count" %}selected{% endif %}>Sort: Popularity</option>
        </select>
    </form>

    {% if presets %}
        <div class="card-grid">
            {% for preset in presets %}
                {% include "presets/_preset_card.html" %}
            {% endfor %}
        </div>
    {% else %}
        <p style="margin-top: 2rem; text-align: center;">You have not created any presets yet.</p>
    {% endif %}
{% endblock %}