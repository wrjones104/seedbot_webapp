{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SeedBot{% endblock %}</title>
    
    <link rel="icon" type="image/png" href="{% static 'images/seedbot_new.png' %}">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
</head>
<body>
    
    <nav class="container">
        <ul>
            <li>
                <a href="{% url 'preset-list' %}" class="secondary">
                    <img src="{% static 'images/seedbot_new.png' %}" alt="SeedBot" style="height: 32px; vertical-align: middle; margin-right: 10px;">
                    <strong>SeedBot</strong>
                </a>
            </li>
        </ul>
        <ul>
            <li><a href="{% url 'preset-list' %}">All Presets</a></li>
            {% if user.is_authenticated %}
                <li><a href="{% url 'my-presets' %}">My Profile</a></li>
                <li><a href="#" role="button" onclick="openModal('logout-modal')">Logout</a></li>
            {% else %}
                <li><a href="{% url 'account_login' %}" role="button">Login</a></li>
            {% endif %}
        </ul>
    </nav>

    <main class="container">
        {% csrf_token %}
        {% block content %}
        {% endblock %}
    </main>

    <dialog id="logout-modal">
        <article style="text-align: center;">
            <header>
                <button aria-label="Close" rel="prev" onclick="closeModal('logout-modal')"></button>
                <img src="{% static 'images/seedbot_new.png' %}" alt="SeedBot" style="height: 64px;">
            </header>
            <p>
                <strong>Are you sure you want to log out?</strong>
            </p>
            <footer class="button-group">
                <form>
                    <button type="button" class="secondary" onclick="closeModal('logout-modal')">Cancel</button>
                </form>
                <form method="post" action="{% url 'account_logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="contrast">Log Out</button>
                </form>
            </footer>
        </article>
    </dialog>

    <dialog id="seed-roll-modal">
        <article style="text-align: center;">
            <header>
                <button aria-label="Close" rel="prev" onclick="closeModal('seed-roll-modal')"></button>
                <h3 id="seed-roll-modal-header">Rolling Seed...</h3>
            </header>
            <div id="seed-roll-modal-content">
                <img src="{% static 'images/seedbot_new.png' %}" alt="SeedBot" style="height: 64px;">
                <p>Please wait while we generate your seed.</p>
                <progress indeterminate></progress>
            </div>
            <footer style="display: none;" id="seed-roll-modal-footer">
                <button class="secondary" onclick="closeModal('seed-roll-modal')">Close</button>
            </footer>
        </article>
    </dialog>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{% static 'js/pico.min.js' %}"></script>

    <script>
        const SILLY_THINGS = {{ silly_things_json|default:'[]'|safe }};

        function openModal(modalId) {
            document.getElementById(modalId)?.showModal();
        }
        function closeModal(modalId) {
            document.getElementById(modalId)?.close();
        }

        function pollTaskStatus(statusUrl) {
            const modal = document.getElementById('seed-roll-modal');
            const header = document.getElementById('seed-roll-modal-header');
            const content = document.getElementById('seed-roll-modal-content');
            const footer = document.getElementById('seed-roll-modal-footer');

            const interval = setInterval(() => {
                fetch(statusUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'SUCCESS') {
                            clearInterval(interval);
                            header.innerText = 'Seed Generated!';
                            content.innerHTML = `<p>Your seed is ready! It will download automatically.</p><h4><a href="${data.result}" target="_blank" download>Download Seed File</a></h4>`;
                            footer.style.display = 'block';
                            window.location.href = data.result;
                        } else if (data.status === 'FAILURE') {
                            clearInterval(interval);
                            header.innerText = 'An Error Occurred';
                            content.innerHTML = `<p>Could not generate seed.</p><p><small>${data.result || 'Unknown error.'}</small></p>`;
                            footer.style.display = 'block';
                        } else if (data.status === 'PROGRESS') {
                            header.innerText = data.result; // e.g., "Applying Tunes..."
                        }                    })
                    .catch(error => {
                        clearInterval(interval);
                        console.error('Error polling task status:', error);
                        header.innerText = 'An Error Occurred';
                        content.innerHTML = `<p>A network error occurred while trying to check the seed status.</p>`;
                        footer.style.display = 'block';
                    });
            }, 3000);
        }

        function checkSectionVisibility() {
            const featuredGrid = $('#featured-grid');
            const featuredHeader = $('#featured-header');
            const favoriteGrid = $('#favorites-grid');
            const favoriteHeader = $('#favorites-header');
            const presetsHr = $('#presets-hr');

            if (featuredGrid.children('article').length > 0) {
                featuredHeader.show();
            } else {
                featuredHeader.hide();
            }

            if (favoriteGrid.children('article').length > 0) {
                favoriteHeader.show();
            } else {
                favoriteHeader.hide();
            }

            if (featuredGrid.children('article').length > 0 || favoriteGrid.children('article').length > 0) {
                presetsHr.show();
            } else {
                presetsHr.hide();
            }
        }

        jQuery(document).ready(function($) {
            $('#id_arguments').select2({ placeholder: 'Select arguments', allowClear: true });

            $(document).on('click', '.js-roll-seed-dispatcher', function() {
                const button = $(this);
                const dispatcherUrl = button.data('url');
                const statusUrlBase = button.data('status-url-base');
                
                const modal = document.getElementById('seed-roll-modal');
                const header = document.getElementById('seed-roll-modal-header');
                const content = document.getElementById('seed-roll-modal-content');
                const footer = document.getElementById('seed-roll-modal-footer');
                const randomLine = SILLY_THINGS.length > 0 ? SILLY_THINGS[Math.floor(Math.random() * SILLY_THINGS.length)] : "Rolling your seed...";
                
                header.innerText = 'Rolling Seed...';
                content.innerHTML = `<img src="{% static 'images/seedbot_new.png' %}" alt="SeedBot" style="height: 64px;"><p><strong>${randomLine.charAt(0).toUpperCase() + randomLine.slice(1)}</strong></p><progress indeterminate></progress>`;
                footer.style.display = 'none';
                openModal('seed-roll-modal');

                const csrfToken = $('[name=csrfmiddlewaretoken]').val();

                fetch(dispatcherUrl, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 403) throw new Error('Please log in to roll a seed.');
                        throw new Error('Server error when trying to roll the seed.');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.method === 'local') {
                        const statusUrl = statusUrlBase.replace('TASK_ID_PLACEHOLDER', data.task_id);
                        pollTaskStatus(statusUrl);
                    } else if (data.method === 'api') {
                        header.innerText = 'Seed Generated!';
                        content.innerHTML = `<p>Your seed is ready!</p><h4><a href="${data.seed_url}" target="_blank">${data.seed_url}</a></h4>`;
                        footer.style.display = 'block';
                    } else if (data.error) {
                         header.innerText = 'An Error Occurred';
                         content.innerHTML = `<p>${data.error}</p>`;
                         footer.style.display = 'block';
                    }
                })
                .catch(error => {
                    header.innerText = 'An Error Occurred';
                    content.innerHTML = `<p>${error.message}</p>`;
                    footer.style.display = 'block';
                });
            });

            $('#submit-form-link').on('click', function(e) {
                e.preventDefault();
                openModal('loading-modal');
                $('#preset-form').submit();
            });

            $(document).on('click', '.js-feature-btn', function() {
                const button = $(this);
                const featureUrl = button.data('url');
                const card = button.closest('article');
                const csrfToken = $('[name=csrfmiddlewaretoken]').val();
                fetch(featureUrl, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (data.featured) {
                            card.fadeOut(200, function() {
                                $('#featured-grid').prepend(card);
                                card.fadeIn(200);
                                checkSectionVisibility();
                            });
                        } else {
                            card.fadeOut(200, function() {
                                $('#regular-grid').prepend(card);
                                card.fadeIn(200);
                                checkSectionVisibility();
                            });
                        }
                    }
                });
            });

            $(document).on('click', '.js-favorite-btn', function() {
                const button = $(this);
                const favoriteUrl = button.data('url');
                const card = button.closest('article');
                const csrfToken = $('[name=csrfmiddlewaretoken]').val();

                fetch(favoriteUrl, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        button.toggleClass('favorited');
                        if (data.favorited) {
                            card.fadeOut(200, function() {
                                $('#favorites-grid').prepend(card);
                                card.fadeIn(200);
                                checkSectionVisibility();
                            });
                        } else {
                            card.fadeOut(200, function() {
                                $('#regular-grid').prepend(card);
                                card.fadeIn(200);
                                checkSectionVisibility();
                            });
                        }
                    }
                });
            });
            checkSectionVisibility();
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>